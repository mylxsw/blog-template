<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{title}}</title>
    <link rel="stylesheet" href="/styles/modern.css">
    <link rel="alternate" type="application/rss+xml" title="{{site.title}} RSS Feed" href="/rss.xml">
    <link rel="sitemap" type="application/xml" title="Sitemap" href="/sitemap.xml">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: { 500: '#6366F1', 600: '#4F46E5', 700: '#4338CA' },
              accent: { 400: '#38BDF8', 500: '#0EA5E9' }
            }
          }
        }
      }
    </script>
</head>
<body class="theme-modern theme-light antialiased">
    <header class="navbar">
        <div class="navbar-container">
            <div class="navbar-brand">
                <a href="/" class="navbar-logo">{{site.title}}</a>
            </div>
            <div class="navbar-right">
                <button type="button" class="theme-toggle" data-theme-toggle aria-label="ÂàáÊç¢‰∏∫ÊöóËâ≤Ê®°Âºè">
                    <span class="theme-toggle-icon" data-theme-icon>üåô</span>
                </button>
                <nav class="navbar-menu" id="navbar-menu">
                    <div class="navbar-nav">
                        <a href="/" class="nav-item {{#if (eq navigation.activePage 'home')}}active{{/if}}">
                            <span class="nav-text">È¶ñÈ°µ</span>
                        </a>
                        {{#if navigation.categories.hasCategories}}
                            {{#each navigation.categories.primary}}
                                <a href="{{url}}" class="nav-item {{#if (eq slug ../navigation.activeCategorySlug)}}active{{/if}}">
                                    <span class="nav-text">{{name}}</span>
                                </a>
                            {{/each}}
                            {{#if navigation.categories.more.length}}
                                <div class="nav-item nav-dropdown">
                                    <button type="button" class="nav-dropdown-toggle" aria-expanded="false">
                                        <span class="nav-text">{{navigation.categories.moreLabel}}</span>
                                        <span class="nav-dropdown-icon">‚ñæ</span>
                                    </button>
                                    <div class="nav-dropdown-menu" hidden>
                                        {{#each navigation.categories.more}}
                                            <a href="{{url}}" class="nav-dropdown-item {{#if (eq slug ../../navigation.activeCategorySlug)}}active{{/if}}">{{name}}</a>
                                        {{/each}}
                                    </div>
                                </div>
                            {{/if}}
                        {{/if}}
                        <a href="/about.html" class="nav-item {{#if (eq navigation.activePage 'about')}}active{{/if}}">
                            <span class="nav-text">ÂÖ≥‰∫é</span>
                        </a>
                        <a href="/rss.xml" class="nav-item nav-item-special" target="_blank" rel="noopener noreferrer">
                            <span class="nav-text">RSS</span>
                        </a>
                    </div>
                </nav>
            </div>
            <button class="navbar-toggle" id="navbar-toggle" aria-label="ÂàáÊç¢ÂØºËà™ËèúÂçï">
                <span></span>
                <span></span>
                <span></span>
            </button>
        </div>
    </header>
    <main class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
        <div class="filter-toggle-area">
            <button type="button" class="filter-toggle-btn" id="post-filter-toggle" aria-expanded="false">
                <span class="filter-toggle-label">Á≠õÈÄâÊñáÁ´†</span>
                <span class="filter-toggle-icon" aria-hidden="true">Ôºã</span>
            </button>
        </div>
        <section class="post-filters" aria-label="ÊñáÁ´†Á≠õÈÄâ" id="post-filters" hidden>
            <div class="search-field">
                <span class="search-icon" aria-hidden="true">üîç</span>
                <input type="search" id="post-search" class="search-input" placeholder="ÊêúÁ¥¢ÊñáÁ´†..." autocomplete="off" spellcheck="false">
            </div>
            {{#if hasTagFilters}}
            <div class="tag-filter" id="tag-filter" role="list">
                <button type="button" class="tag-filter-btn active" data-tag="">ÂÖ®ÈÉ®</button>
                {{#each availableTags}}
                <button type="button" class="tag-filter-btn" data-tag="{{name}}">{{name}}</button>
                {{/each}}
            </div>
            {{/if}}
        </section>

        <div id="search-results" class="post-list" hidden></div>

        <div id="default-posts" data-default-posts>
        <div class="post-list">
            {{#posts}}
            <article class="post-card">
                {{#if coverImage}}
                <div class="overflow-hidden">
                    <img src="{{coverImage}}" alt="{{title}}" class="post-image" loading="lazy" onerror="this.onerror=null;this.src='/assets/placeholder.svg';this.classList.add('placeholder');">
                </div>
                {{/if}}
                <div class="post-content-area">
                    <h2><a href="{{url}}" class="post-title">{{title}}</a></h2>
                    <div class="post-meta">
                        <div class="post-date">
                            <time datetime="{{dateISO}}">{{dateFormatted}}</time>
                        </div>
                        {{#if category}}
                        <div class="post-category">
                            <a href="{{category.url}}" class="post-category-link">{{category.name}}</a>
                        </div>
                        {{/if}}
                        {{#if tags}}
                        <div class="post-tags">
                            {{#each tags}}
                            <a href="{{url}}" class="post-tag">{{name}}</a>
                            {{/each}}
                        </div>
                        {{/if}}
                    </div>
                    <div class="post-excerpt">
                        {{{excerpt}}}
                    </div>
                </div>
            </article>
            {{/posts}}
        </div>

        <div class="pagination">
            {{#if pagination.hasPrev}}
                {{#if (eq pagination.prevPage 1)}}
                    <a href="/" class="pagination-item">&laquo; ‰∏ä‰∏ÄÈ°µ</a>
                {{else}}
                    <a href="/page/{{pagination.prevPage}}/" class="pagination-item">&laquo; ‰∏ä‰∏ÄÈ°µ</a>
                {{/if}}
            {{/if}}

            {{#each (range 1 pagination.totalPages)}}
                {{#if (eq this ../pagination.currentPage)}}
                    <span class="pagination-current">{{this}}</span>
                {{else}}
                    {{#if (eq this 1)}}
                        <a href="/" class="pagination-item">{{this}}</a>
                    {{else}}
                        <a href="/page/{{this}}/" class="pagination-item">{{this}}</a>
                    {{/if}}
                {{/if}}
            {{/each}}

            {{#if pagination.hasNext}}
                <a href="/page/{{pagination.nextPage}}/" class="pagination-item">‰∏ã‰∏ÄÈ°µ &raquo;</a>
            {{/if}}
        </div>
        </div>
    </main>
    <footer class="footer">
        <div class="max-w-6xl mx-auto px-4">
            <p>&copy; {{site.copyrightYear}} {{site.title}}. All rights reserved.</p>
            <p class="mt-2"><a href="/rss.xml" class="text-accent-400 hover:text-accent-500">üì° ËÆ¢ÈòÖ RSS</a></p>
        </div>
    </footer>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('img').forEach(img => {
                img.addEventListener('error', function() {
                    if (this.dataset.fallbackApplied) return;
                    this.dataset.fallbackApplied = '1';
                    this.src = '/assets/placeholder.png';
                    this.classList.add('placeholder');
                }, { once: true });
            });
            const navbarToggle = document.getElementById('navbar-toggle');
            const navbarMenu = document.getElementById('navbar-menu');

            if (navbarToggle && navbarMenu) {
                navbarToggle.addEventListener('click', function() {
                    navbarToggle.classList.toggle('open');
                    navbarMenu.classList.toggle('open');
                });

                const navItems = navbarMenu.querySelectorAll('.nav-item');
                navItems.forEach(item => {
                    item.addEventListener('click', function() {
                        navbarToggle.classList.remove('open');
                        navbarMenu.classList.remove('open');
                    });
                });

                document.addEventListener('click', function(e) {
                    if (!navbarToggle.contains(e.target) && !navbarMenu.contains(e.target)) {
                        navbarToggle.classList.remove('open');
                        navbarMenu.classList.remove('open');
                    }
                });
            }

            const dropdowns = document.querySelectorAll('.nav-dropdown');
            dropdowns.forEach(dropdown => {
                const toggle = dropdown.querySelector('.nav-dropdown-toggle');
                const menu = dropdown.querySelector('.nav-dropdown-menu');
                if (!toggle || !menu) return;
                toggle.addEventListener('click', () => {
                    const expanded = toggle.getAttribute('aria-expanded') === 'true';
                    toggle.setAttribute('aria-expanded', String(!expanded));
                    menu.hidden = expanded;
                });
                document.addEventListener('click', (event) => {
                    if (!dropdown.contains(event.target)) {
                        toggle.setAttribute('aria-expanded', 'false');
                        menu.hidden = true;
                    }
                });
            });

            document.body.addEventListener('click', async (e) => {
                const btn = e.target.closest('.copy-code-btn');
                if (!btn) return;
                const container = btn.closest('.code-block');
                if (!container) return;
                const codeEl = container.querySelector('pre code');
                if (!codeEl) return;
                const text = codeEl.innerText;
                try {
                    await navigator.clipboard.writeText(text);
                    const original = btn.textContent;
                    btn.textContent = 'Â∑≤Â§çÂà∂';
                    btn.classList.add('copied');
                    setTimeout(() => {
                        btn.textContent = original;
                        btn.classList.remove('copied');
                    }, 1200);
                } catch (err) {
                    const textarea = document.createElement('textarea');
                    textarea.value = text;
                    document.body.appendChild(textarea);
                    textarea.select();
                    try { document.execCommand('copy'); } catch {}
                    document.body.removeChild(textarea);
                    const original = btn.textContent;
                    btn.textContent = 'Â∑≤Â§çÂà∂';
                    btn.classList.add('copied');
                    setTimeout(() => {
                        btn.textContent = original;
                        btn.classList.remove('copied');
                    }, 1200);
                }
            });

            const themeToggleButtons = document.querySelectorAll('[data-theme-toggle]');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)');

            const applyTheme = (theme, persist = true) => {
                const isDark = theme === 'dark';
                document.body.classList.toggle('theme-dark', isDark);
                document.body.classList.toggle('theme-light', !isDark);
                document.body.setAttribute('data-theme', theme);
                themeToggleButtons.forEach(button => {
                    const icon = button.querySelector('[data-theme-icon]');
                    if (icon) {
                        icon.textContent = isDark ? 'üåû' : 'üåô';
                    }
                    button.setAttribute('aria-label', isDark ? 'ÂàáÊç¢‰∏∫‰∫ÆËâ≤Ê®°Âºè' : 'ÂàáÊç¢‰∏∫ÊöóËâ≤Ê®°Âºè');
                });
                if (persist) {
                    localStorage.setItem('theme', theme);
                }
            };

            const storedTheme = localStorage.getItem('theme');
            if (storedTheme) {
                applyTheme(storedTheme, false);
            } else {
                applyTheme(prefersDark.matches ? 'dark' : 'light', false);
            }

            themeToggleButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const nextTheme = document.body.classList.contains('theme-dark') ? 'light' : 'dark';
                    applyTheme(nextTheme, true);
                });
            });

            prefersDark.addEventListener('change', (event) => {
                if (!localStorage.getItem('theme')) {
                    applyTheme(event.matches ? 'dark' : 'light', false);
                }
            });

            const searchInput = document.getElementById('post-search');
            const tagFilter = document.getElementById('tag-filter');
            const searchResultsContainer = document.getElementById('search-results');
            const defaultPostsContainer = document.querySelector('[data-default-posts]');
            const paginationEl = document.querySelector('.pagination');
            const filterToggle = document.getElementById('post-filter-toggle');
            const filterPanel = document.getElementById('post-filters');

            const activeTags = new Set();
            let searchTerm = '';
            let searchIndex = [];

            const escapeHtml = (value) => {
                return String(value || '')
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/"/g, '&quot;')
                    .replace(/'/g, '&#39;');
            };

            const ensureFiltersVisible = () => {
                if (!filterToggle || !filterPanel) return;
                filterPanel.hidden = false;
                filterToggle.setAttribute('aria-expanded', 'true');
                filterToggle.classList.add('expanded');
                const icon = filterToggle.querySelector('.filter-toggle-icon');
                if (icon) icon.textContent = 'Ôºç';
            };

            const renderResults = () => {
                const hasActiveFilters = searchTerm.length > 0 || activeTags.size > 0;
                if (!hasActiveFilters) {
                    searchResultsContainer.hidden = true;
                    searchResultsContainer.innerHTML = '';
                    if (defaultPostsContainer) defaultPostsContainer.hidden = false;
                    if (paginationEl) paginationEl.hidden = false;
                    return;
                }

                ensureFiltersVisible();

                const normalizedTerm = searchTerm.toLowerCase();
                const filtered = searchIndex.filter(item => {
                    const matchesTerm = !normalizedTerm || (
                        item.title.toLowerCase().includes(normalizedTerm) ||
                        item.excerpt.toLowerCase().includes(normalizedTerm) ||
                        item.content.toLowerCase().includes(normalizedTerm)
                    );
                    const matchesTags = activeTags.size === 0 || item.tags.some(tag => activeTags.has(tag));
                    return matchesTerm && matchesTags;
                });

                if (defaultPostsContainer) defaultPostsContainer.hidden = true;
                if (paginationEl) paginationEl.hidden = true;
                searchResultsContainer.hidden = false;

                if (!filtered.length) {
                    searchResultsContainer.innerHTML = '<div class="empty-state">Ê≤°ÊúâÊâæÂà∞ÂåπÈÖçÁöÑÊñáÁ´†„ÄÇ</div>';
                    return;
                }

                const cards = filtered.map(item => {
                    const tagsHtml = (item.tagLinks || []).map(tag => `<a class="post-tag" href="${escapeHtml(tag.url)}">${escapeHtml(tag.name)}</a>`).join('');
                    const categoryHtml = item.category && item.category.url
                        ? `<div class=\"post-category\"><a class=\"post-category-link\" href=\"${escapeHtml(item.category.url)}\">${escapeHtml(item.category.name)}</a></div>`
                        : '';
                    const coverHtml = item.coverImage
                        ? `<div class=\"overflow-hidden\"><img src=\"${escapeHtml(item.coverImage)}\" alt=\"${escapeHtml(item.title)}\" class=\"post-image\" loading=\"lazy\" onerror=\"this.onerror=null;this.src='/assets/placeholder.svg';this.classList.add('placeholder');\"></div>`
                        : '';
                    return `
                        <article class="post-card">
                            ${coverHtml}
                            <div class="post-content-area">
                                <h2><a href="${escapeHtml(item.url)}" class="post-title">${escapeHtml(item.title)}</a></h2>
                                <div class="post-meta">
                                    <div class="post-date">
                                        <time datetime="${escapeHtml(item.dateISO)}">${escapeHtml(item.dateFormatted)}</time>
                                    </div>
                                    ${categoryHtml}
                                    ${(item.tagLinks && item.tagLinks.length) ? `<div class=\"post-tags\">${tagsHtml}</div>` : ''}
                                </div>
                                <div class="post-excerpt">${escapeHtml(item.excerpt)}</div>
                            </div>
                        </article>`;
                }).join('');

                searchResultsContainer.innerHTML = cards;
            };

            const updateTagButtonStates = () => {
                if (!tagFilter) return;
                const buttons = tagFilter.querySelectorAll('[data-tag]');
                buttons.forEach(button => {
                    const tag = button.dataset.tag;
                    if (!tag) {
                        if (activeTags.size === 0) {
                            button.classList.add('active');
                        } else {
                            button.classList.remove('active');
                        }
                        return;
                    }
                    if (activeTags.has(tag)) {
                        button.classList.add('active');
                    } else {
                        button.classList.remove('active');
                    }
                });
            };

            const ensureSearchIndex = async () => {
                if (searchIndex.length) return;
                try {
                    const response = await fetch('/search.json');
                    if (!response.ok) throw new Error('Failed to load search index');
                    const payload = await response.json();
                    searchIndex = Array.isArray(payload.posts) ? payload.posts : [];
                } catch (err) {
                    console.error(err);
                    searchResultsContainer.innerHTML = '<div class="empty-state">ÊêúÁ¥¢Á¥¢ÂºïÂä†ËΩΩÂ§±Ë¥•ÔºåËØ∑Á®çÂêéÂÜçËØï„ÄÇ</div>';
                }
            };

            if (searchInput) {
                searchInput.addEventListener('input', async (event) => {
                    searchTerm = event.target.value.trim();
                    await ensureSearchIndex();
                    renderResults();
                });
            }

            if (tagFilter) {
                tagFilter.addEventListener('click', async (event) => {
                    const button = event.target.closest('[data-tag]');
                    if (!button) return;
                    const tag = button.dataset.tag;

                    await ensureSearchIndex();

                    if (!tag) {
                        activeTags.clear();
                    } else if (activeTags.has(tag)) {
                        activeTags.delete(tag);
                    } else {
                        activeTags.add(tag);
                    }

                    updateTagButtonStates();
                    renderResults();
                });
            }

            if (filterToggle && filterPanel) {
                filterToggle.addEventListener('click', () => {
                    const expanded = filterToggle.getAttribute('aria-expanded') === 'true';
                    filterToggle.setAttribute('aria-expanded', String(!expanded));
                    filterPanel.hidden = expanded;
                    filterToggle.classList.toggle('expanded', !expanded);
                    const icon = filterToggle.querySelector('.filter-toggle-icon');
                    if (icon) icon.textContent = expanded ? 'Ôºã' : 'Ôºç';
                });
            }
        });
    </script>
</body>
</html>
